
var ajax = require("./ajax");
var constant=require("./CONSTANTS");
var utility = require('./utility-functions');
var _ = require('underscore')._;
var moment = require("moment");
var request = require('request');



this.updateDate = function(){

    var events = [
        "Of65a7ce7cd",
        "Oe8d9b3f1ce",
        "O830181e615",
        "Ob791c41493",
        "Ob791c41492",
        "Ob791c41495",
        "Ob791c41494",
        "Ob791c41496",
        "Ob791c41497",
        "Ob791c41498",
        "Ob791c41499",
        "Ob791c41501",
        "Ob791c41502",
        "Ob791c41503",
        "Ob791c41504",
        "Ob791c41506",
        "Ob791c41505",
        "Ob791c41509",
        "Ob791c41507",
        "Ob791c41508",
        "Ob791c41510",
        "Ob791c41511",
        "Ob791c41512",
        "Ob791c41513",
        "Ob791c41514",
        "Ob791c41515",
        "Ob791c41516",
        "Ob791c41517",
        "Ob791c41520",
        "Ob791c41519",
        "Ob791c41518",
        "Ob791c41521",
        "Ob791c41524",
        "Ob791c41525",
        "Ob791c41526",
        "Ob791c41522",
        "Ob791c41523",
        "Ob791c41527",
        "Oad9093ae07",
        "Ob791c41528",
        "Ob791c41530",
        "Ob791c41529",
        "Ob791c41531",
        "Ob791c41532",
        "Ob791c41538",
        "Ob791c41533",
        "Ob791c41535",
        "Ob791c41537",
        "Ob791c41536",
        "Ob791c41540",
        "Ob791c41539",
        "Ob791c41541",
        "Ob791c41542",
        "Ob791c41544",
        "Ob791c41543",
        "Ob791c41546",
        "Ob791c41547",
        "Ob791c41552",
        "Ob791c41553",
        "Ob791c41554",
        "O8aaf2be806",
        "O22a408e368",
        "O8da107444b",
        "O96ab1c7110",
        "O7bdb173507",
        "Oad1f0c67e5",
        "Ob791c41555",
        "O910433cd5c",
        "O5829d8b2f7",
        "Ob791c41556",
        "Ob791c41557",
        "O8feb4c66ee",
        "O83f3be9888",
        "Of3ba8639d2",
        "Oa9892e9131",
        "Ob791c41558",
        "O4da71cae15",
        "O444136dadc",
        "Ob791c41559",
        "O0d065550ce",
        "Oa08d120f8e",
        "O85b6cd1b43",
        "Oaa6cfac2bc",
        "Ob791c41560",
        "Ob791c41561",
        "O5a2f82b3b2",
        "Ob791c41562",
        "O66863e5f4f",
        "O5f09e949d3",
        "Occ3f417f2f",
        "Oe42afe3b55",
        "O37f6d7e902",
        "Ob791c41563",
        "O2da0760dc1",
        "O5f1ddc50ae",
        "Ob791c41566",
        "Oa1099eb340",
        "Ob791c41568",
        "Ob791c41567",
        "Ob814e17efd",
        "O13d61af3e2",
        "Ob791c41565",
        "Ob791c41564",
        "Oa4843e49c8",
        "O4f30aae179",
        "Ob791c41571",
        "Ob791c41569",
        "O25cfb4c99f",
        "O687e36d27c",
        "Odf0a9899bd",
        "O3ccecb7db9",
        "Ob791c41570",
        "O4646c7a3f7",
        "Ob791c41572",
        "O2a78d8e876",
        "Odbabcdf090",
        "O0e09bf0d92",
        "O37d246d3ee",
        "Oa9990aee57",
        "Oc99faad668",
        "Oa60a14ed1d",
        "O9d2ddcf978",
        "Ob791c41575",
        "Ob791c41576",
        "Oa490baf370",
        "Ofa8c69d177",
        "Obba60d57f3",
        "O0396fde7a0",
        "O7687b8bf44",
        "Ob791c41577",
        "Oea62430cba",
        "O944d697845",
        "Oc09961e3bd",
        "Ob791c41578",
        "Ob791c41580",
        "Ob791c41583",
        "Ob791c41582",
        "Of55c7fc75a",
        "O2ab22d0271",
        "Oa0bd4ea7fc",
        "O7ef3916590",
        "Ob791c41585",
        "Ob791c41587",
        "Ob791c41588",
        "O0d7b3a3cd3",
        "O422518c19a",
        "Oeb2cb483b1",
        "Of5e476c2ea",
        "O445888ebf6",
        "Ob791c41591",
        "Ob791c41590",
        "O2fcbbb0d0e",
        "Ob791c41589",
        "Obc55f6e704",
        "Ob884a094ae",
        "Ob791c41592",
        "Oee2a924c15",
        "O183a71f9f9",
        "Ob791c41593",
        "Ob791c41595",
        "O47764dcdc9",
        "O577d273574",
        "O3ab0c3db1f",
        "Oa547da11b3",
        "Oa0cc69e96b",
        "Oce3353d051",
        "Ob340e19be4",
        "O4f29fec74c",
        "O12418cc718",
        "O91ea7afba2",
        "O187c5507a9",
        "O71cd63dadd",
        "Od7caec01dc",
        "O68fb1bde33",
        "Ofcccee6ceb",
        "O09bdc2c16b",
        "Ofe24d01dc0",
        "O5618dcff37",
        "Oee706a95e3",
        "Ob3282222b6",
        "O0964e9beb0",
        "Oc989f32949",
        "O3fc075b80a",
        "O68164a8940",
        "O19ac2537de",
        "Of02d10586c",
        "Ofb34e7cbb6",
        "Obeabcb151d",
        "O9257bdb77f",
        "Oa27fc92af5",
        "Oba7248a978",
        "O914efa2f9c",
        "O920dbb5ea0",
        "Oa983c56765",
        "O0895074db2",
        "O3fdd79187d",
        "O4e5a061a95",
        "O2919442d2e",
        "O647f1c109a",
        "O43605a72d0",
        "O3161ce838a",
        "O8b0f809a5b",
        "O6843d1a278",
        "O5679029a63",
        "O43ada554b3",
        "O4b869822ea",
        "O627b9e8c73",
        "O3c2dfbdd66",
        "O602128147c",
        "Obef10d67e8",
        "O110dea870e",
        "Oc58ba17ad9",
        "Off08275e3b",
        "Oac0aa6b9fa",
        "O72552055ac",
        "Obcff0631c1",
        "O8f836e5fae",
        "O4653c52af7",
        "O0aa0b807bd",
        "O06afa782bb",
        "O469dcb87e9",
        "O2663ce3ef9",
        "O4ad9cbb15a",
        "O2f7d5b9434",
        "O79defd18f2",
        "O99c8e2170f",
        "O3a4eed2350",
        "O3c5ab99520",
        "Ocbf43dfaab",
        "O7c27184847",
        "O44d753a4c4",
        "O45855cf80a",
        "Oe44eeaf933",
        "O33c62d973c",
        "Ofdcc8ca0ab",
        "Obfdfad11d0",
        "O6c9ebd89b9",
        "Ob573959fb0",
        "Oa735977252",
        "O2f39496cf2",
        "O0a610c1b04",
        "O5c3dcb8bf4",
        "Obd48a74390",
        "O7f90dcb551",
        "O344e5e3291",
        "O88b3b7c5e0",
        "O6419900022",
        "O77b573855a",
        "Of9b209f05e",
        "O1b6daaa676",
        "O9413f62d67",
        "O733516f9e6",
        "O496c97b561",
        "O9cb33cfa09",
        "O22213dbbb9",
        "Oae0de636c9",
        "O57f789bb8d",
        "O97ed27c34a",
        "Of110574014",
        "O2c211e1760",
        "O7c90a5a6c8",
        "O1d3f58cdcb",
        "Oc7168d21b5",
        "O4bc60ce813",
        "Oc434d54169",
        "O189a682e23",
        "O5e4d5cb616",
        "Ode70c7794c",
        "O5b85ee1c4b",
        "O909a4736aa",
        "Oda2da2aac7",
        "Ob3d4851639",
        "O3ffaf06044",
        "O2e0ec4dd27",
        "Oec26150b1a",
        "Od80beb2a7a",
        "O54328574dc",
        "Of65268be75",
        "Of3a0bba25b",
        "O91b02f9892",
        "Oe8314a0534",
        "O093e78878b",
        "O2aa35d8fc3",
        "Od84a3cc285",
        "Ob76fbdbc5a",
        "Oc709c8a182",
        "Oa514116d37",
        "Oa656ecb978",
        "O2b22124f0c",
        "Od51af83156",
        "O6d01fa0ae8",
        "Occ8cfb3983",
        "O9d2cbeb5cb",
        "O09697ba94b",
        "O9d1a7908f3",
        "O162416366d",
        "Oed69d98848",
        "Oe43f859170",
        "O0ec51eccce",
        "Odef2e51582",
        "O08367d6fc6",
        "Oc7e052366b",
        "Od7fae5d865",
        "O0ee68e58b8",
        "Odfec401835",
        "Oa381cdfdd4",
        "O61bf3d99e7",
        "O0bd3c0d5de",
        "O0b28abf01b",
        "O7d6f93815b",
        "Oedae19c720",
        "Oaff102070a",
        "Oecf5268ab1",
        "O0854a2d052",
        "O6ca7049e06",
        "O1e22b94338",
        "O7ead24a794",
        "Of98132b5c5",
        "O5be10dc635",
        "Ob230209f01",
        "O3406d4ef8d",
        "O029fa56c3a",
        "Oe823cb3aeb",
        "Obc40f10527",
        "Obc8b0f3e16",
        "Od590c7efeb",
        "O218729336c",
        "O6923ab37fc",
        "O528cb1a27d",
        "O67cac26ec6",
        "O8b8f96038c",
        "Oa4204092a2",
        "Ob98daf021d",
        "Oa0ff0ec3b1",
        "O8bbf3e9ee2",
        "Oae40f1c80d",
        "Oab509810a9",
        "O36d4c04306",
        "Oda5cc29b2c",
        "Oe6255daea4",
        "O4921b80e05",
        "Ob59ce7540f",
        "O0871776ab4",
        "O725e8f5e31",
        "O787d3631cb",
        "Oea832f5057",
        "Oec6646a3f8",
        "Oaebfdf9ce4",
        "Od678b9d9bf",
        "Ocd7c250582",
        "O25caaa3b51",
        "Oa25eecb9d1",
        "Oed2ee22171",
        "Oa5a17d3b00",
        "O131a542b24",
        "Oc94d992c0e",
        "O2593ade876",
        "Oc7a45ac048",
        "Oe3ea7d0846",
        "Oed3352f76e",
        "O6d1315e742",
        "O2983a6e674",
        "Ob609aad4fe",
        "O336f738c14",
        "O4964587793",
        "O2cd8f47d19",
        "Oc7268e2a36",
        "Obca5026ae0",
        "Od3b1578638",
        "Ocbd2b085a3",
        "O45fabe5399",
        "O68a88a4d7c",
        "O3049e9d88e",
        "Oda5322a932",
        "O477d38dc5c",
        "O2434e5ce63",
        "Oc0785e8e8b",
        "O269bc3223c",
        "O2a4b84e45d",
        "O06a923ad6f",
        "Of06d787472",
        "Of8b45b39d1",
        "O3b9aecb5e4",
        "Ocff640bec9",
        "O7d6a4dfede",
        "O129a2c321e",
        "Ocb9149e495",
        "O1a2efaf748",
        "O8ea59de7ea",
        "O77890c3741",
        "Od66be52745",
        "O992f43dc7b",
        "Od8e1496c5c",
        "O1774049da2",
        "O4dbb6b0e7b",
        "O52c866ec53",
    ]

    getClusterCases(events,function(events){
        var fixedAlgoCases = filterEventsByDataValue(events,"dataElement",constant.DHIS_DE_ODK_FORMID,"value",["DPHL_Lab_V1","eDFSS_IPD_V3"],"include");  

        updateDate(0,fixedAlgoCases)
    });

  function getClusterCases(cases,callback){
        
     //   cases = cases.split(";");
        var clusterCases = [];
        getEvent(0,cases);
        function getEvent(index,cases){
            if (index == cases.length){
                callback(clusterCases);
                return
            }

            ajax.getReq(constant.DHIS_URL_BASE+"/api/events/"+cases[index],constant.auth,
                        function(error,response,body){
                            if (error){
                                console.log("Error Fetch Event")
                            }
                            clusterCases.push(JSON.parse(body));
                            getEvent(index+1,cases);
                        });
        }   
      
  }

    function updateDate(index,events){
        
        if (index == events.length){return}
        var event = events[index];

        var date = utility.findValueAgainstId(event.dataValues,"dataElement",constant.DHIS_DE_DATE,"value");
        if (!date){
            event.dataValues.push({
                dataElement : constant.DHIS_DE_DATE,
                value : moment(event.eventDate).format("YYYY-MM-DD")
            })
        }

        
        
        ajax.putReq(constant.DHIS_URL_BASE+"/api/events/"+event.event,event,constant.auth,function(error,response,body){
            if (error){
                console.log("Error updating event")
            }
            
            updateDate(index+1,events);
        })
        
    }
}

  function filterEventsByDataValue(events,idKey,id,valKey,values,operation){
        var list = [];
        for (var i=0;i<events.length;i++){
            if (utility.checkListForValue(events[i].dataValues,idKey,id,valKey,values)){
                if (operation == "include")  list.push(events[i]);
            }else{
                if (operation == "exclude")  list.push(events[i]);
            }
        }
        return list;
    }

